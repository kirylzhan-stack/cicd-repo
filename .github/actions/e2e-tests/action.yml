name: E2E Tests
description: E2E tests to npm typescript package

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Set-Up local npm registry
      shell: bash
      run: |
        cat <<EOF > verdaccio-config.yaml
        storage: ./verdaccio-storage
        auth:
          htpasswd:
            file: ./htpasswd
        packages:
          '**':
            access: \$all
            publish: \$all
        EOF
        npx verdaccio --config verdaccio-config.yaml --listen 4873 &
        npx wait-on http://localhost:4873

    - name: publish to local npm registry
      shell: bash
      run: |
        npm config set registry http://localhost:4873
        npm config set //localhost:4873/:_authToken "dummy-token"
        npm publish

    - name: Run E2E Package Test
      shell: bash
      run: |
        PACK_NAME=$(jq -r '.name' package.json)
        mkdir -p test
        cd test
        npm init -y
        npm pkg set type="module"
        npm install $PACK_NAME --registry http://localhost:4873
        cat <<EOF > test.js
        import { sparkStatus, tinyWin } from '$PACK_NAME';

        console.log('ðŸ”„ Testing sparkStatus...');
        const status = sparkStatus('Alice', 'turbo');
        if (status !== 'Alice: shipping mode') {
          console.error('âŒ E2E Failed: sparkStatus returned incorrect value ->', status);
          process.exit(1);
        }

        console.log('ðŸ”„ Testing tinyWin...');
        const win = tinyWin(10);
        if (win !== 'big win') {
          console.error('âŒ E2E Failed: tinyWin returned incorrect value ->', win);
          process.exit(1);
        }

        console.log('âœ… All E2E Consumer Tests Passed Successfully!');
        EOF
        node test.js
